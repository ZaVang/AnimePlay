# 《宅理论战》V5.0 战斗系统开发计划

### 核心设计思路与文件结构

#### 1. 技能设计策略：定制与模板化

为使角色设计更高效且易于管理，我们采取分层策略：
- **定制技能：** 为SSR、SR等稀有或核心角色设计独特的、符合其人设的专属技能。这些技能将定义在角色数据文件中。
- **模板技能：** 为R等泛用角色创建一系列标准化的“模板技能”（如“临时加攻”、“少量回复”等）。这些模板技能会存在一个独立的文件中，角色数据文件可以直接引用，大大减少重复定义。

#### 2. 拟定文件结构 (frontend-vue/src)

为了清晰地分离数据、逻辑和视图，我们规划如下文件结构：

```
frontend-vue/
└── src/
    ├── types/                  # (改进) 类型定义文件夹
    │   ├── index.ts           # 导出所有类型
    │   ├── battle.ts          # 战斗相关类型 (GameState, BattleAction等)
    │   ├── character.ts       # 角色相关类型
    │   ├── anime.ts           # 动画卡牌相关类型
    │   └── skill.ts           # 技能相关类型
    │
    ├── data/
    │   ├── characters/        # (改进) 角色数据文件夹
    │   │   ├── index.ts       # 角色数据主入口
    │   │   ├── ssr/           # SSR角色数据
    │   │   │   ├── haruhi.ts
    │   │   │   └── yagami.ts
    │   │   ├── sr/            # SR角色数据
    │   │   ├── mappings.json  # 角色ID映射表
    │   │   └── generator.ts   # 批量生成普通角色
    │   │
    │   ├── animes/            # (改进) 动画卡牌数据文件夹
    │   │   ├── index.ts       # 卡牌数据主入口
    │   │   ├── by-series/     # 按系列组织
    │   │   │   ├── fate.ts
    │   │   │   └── haruhi.ts
    │   │   ├── by-type/       # 按类型组织
    │   │   │   ├── daily.ts
    │   │   │   └── battle.ts
    │   │   └── cardPool.json  # 完整卡池配置
    │   │
    │   └── skills/            # (改进) 技能系统文件夹
    │       ├── index.ts       # 技能系统主入口
    │       ├── unique/        # 独特技能
    │       │   ├── ssr-skills.ts
    │       │   └── special-sr.ts
    │       ├── templates/     # 模板技能
    │       │   ├── passive/   # 被动技能模板
    │       │   │   ├── type-bonus.ts
    │       │   │   └── team-aura.ts
    │       │   └── active/    # 主动技能模板
    │       │       ├── offensive.ts
    │       │       └── defensive.ts
    │       ├── effects/       # (新增) 技能效果实现
    │       │   └── index.ts
    │       └── skillManager.ts # 技能管理器
    │
    ├── core/                   
    │   ├── data/              # (新增) 数据处理层
    │   │   └── DataLoader.ts    # 负责从外部JSON加载并转换数据
    │   │
    │   ├── battle/            # (改进) 战斗核心文件夹
    │   │   ├── BattleController.ts    # 战斗主控制器
    │   │   ├── TurnManager.ts         # 回合管理器
    │   │   ├── PhaseManager.ts        # 阶段管理器（新增）
    │   │   └── BattleValidator.ts     # 战斗规则验证器（新增）
    │   │
    │   ├── calculation/       # (新增) 计算引擎文件夹
    │   │   ├── StrengthCalculator.ts  # 强度计算
    │   │   ├── RewardCalculator.ts    # 收益计算
    │   │   └── FormulaEngine.ts       # 公式引擎
    │   │
    │   ├── systems/           # (改进) 各子系统
    │   │   ├── ResourceManager.ts     # 资源管理（TP、手牌）
    │   │   ├── SkillSystem.ts         # 技能系统
    │   │   ├── StatusEffectSystem.ts  # 状态效果系统（新增）
    │   │   ├── SynergySystem.ts       # 羁绊系统
    │   │   └── TopicBiasSystem.ts     # 议题偏向系统（新增）
    │   │
    │   └── ai/                # (可选) AI系统
    │       ├── AIController.ts
    │       └── strategies/
    │
    ├── stores/
    │   ├── battle/            # (改进) 战斗相关store
    │   │   ├── index.ts       # 战斗store主入口
    │   │   ├── gameStore.ts   # 游戏状态 (回合、议题等)
    │   │   ├── playerStore.ts # 玩家状态 (双方玩家)
    │   │   └── historyStore.ts # 战斗历史记录（新增）
    │   │
    │   ├── data/              # (新增) 主数据store
    │   │   └── masterDataStore.ts
    │   │
    │   └── config/            # (新增) 配置store
    │       └── battleConfigStore.ts # 战斗配置（规则、时限等）
    │
    ├── views/
    │   └── BattleView.vue      
    │
    ├── components/
    │   └── battle/             
    │       ├── arena/         # (改进) 战场区域组件
    │       │   ├── PlayerField.vue    # 玩家阵地（包含角色和资源）
    │       │   ├── ClashZone.vue      # 交锋区
    │       │   └── TopicBiasBar.vue   # 议题偏向条
    │       │
    │       ├── character/     # (新增) 角色相关组件
    │       │   ├── CharacterCard.vue  # 单个角色展示
    │       │   ├── CharacterLineup.vue # 角色阵容
    │       │   └── SkillButton.vue    # 技能按钮
    │       │
    │       ├── anime/         # (新增) 动画卡牌相关组件
    │       │   ├── HandDisplay.vue    # 手牌区
    │       │   ├── AnimeItem.vue      # 单张动画卡牌
    │       │   └── AnimeSelector.vue  # 动画卡牌选择器
    │       │
    │       ├── ui/            # (新增) UI组件
    │       │   ├── ActionPanel.vue    # 操作面板
    │       │   ├── BattleLog.vue      # 战斗日志
    │       │   ├── TurnIndicator.vue  # 回合指示器
    │       │   └── Timer.vue          # 计时器
    │       │
    │       └── effects/       # (新增) 特效组件
    │           ├── DamageNumber.vue   # 伤害数字
    │           └── StatusIcon.vue     # 状态图标
    │
    ├── composables/           # (新增) 可复用逻辑
    │   └── battle/
    │       ├── useBattleActions.ts    # 战斗操作逻辑
    │       ├── useBattleAnimation.ts  # 动画控制
    │       └── useBattleSound.ts      # 音效控制
    │
    └── utils/                 # (新增) 工具函数
        └── battle/
            ├── validators.ts   # 验证函数
            ├── formatters.ts   # 格式化函数
            └── constants.ts    # 常量定义

```

---

### 第一阶段：项目基础与核心数据结构

**目标：** 搭建游戏运行的基础框架，定义所有核心实体的数据模型。

- **1. 数据加载与处理架构:**
    - [x] **定义数据结构:** 为原始JSON数据 (`RawAnimeData`, `RawCharacterData`) 和应用内数据 (`Anime`, `Character`) 创建独立的TypeScript接口。
    - [x] **创建DataLoader:** 实现一个数据加载器，负责读取外部JSON文件，并将其转换为应用内统一的数据模型。
    - [x] **创建主数据Store:** 建立 `masterDataStore`，用于存储加载后的所有番剧和角色主数据，供全应用访问。

- **2. 项目初始化与状态管理:**
    - [ ]  配置 Vue/Pinia 状态管理。
    - [ ]  创建 `gameStore` 用于管理整个对局的状态，如回合数、当前玩家、游戏阶段等。
    - [ ]  创建 `playerStore` 分别管理两位玩家的状态（声望、TP、手牌、牌库、角色阵容等）。

- **2. 定义核心数据结构:**
    - [ ]  **动画 (Anime):** 定义动画卡牌的数据结构，包括ID、名称、稀有度、基础强度、TP消耗、类型、卡图、效果描述等。
    - [ ]  **角色 (Character):** 定义角色的数据结构，包括ID、名称、被动光环、主动技能（含TP消耗、冷却时间）、所属作品、声优等。
    - [ ]  **玩家 (Player):** 定义玩家对象，聚合其声望、TP、手牌、牌库、墓地、角色阵容、技能冷却状态等。
    - [ ]  **游戏状态 (GameState):** 定义全局游戏状态，包括当前回合、当前阶段（抽卡、行动等）、议题偏向值、先后手玩家等。

---

### 第二阶段：核心机制的实现

**目标：** 实现游戏的核心玩法循环，包括资源管理、回合流程和角色互动。

- **3. 资源系统实现:**
    - [ ]  **TP (Talk Points) 系统:**
        - [ ]  实现每回合 `N+1` 的TP恢复逻辑。
        - [ ]  实现TP的消耗与上限机制。
    - [ ]  **手牌与牌库系统:**
        - [ ]  实现回合开始时从牌库抽一张卡。
        - [ ]  实现手牌上限（10张）的规则。
        - [ ]  实现卡牌从牌库到手牌，再到弃牌堆的流转。

- **4. 角色与轮换系统:**
    - [ ]  **角色技能:** 实现主动技能的释放逻辑，包括TP消耗和冷却计时器。
    - [ ]  **被动光环:** 实现一个机制，使得主辩手和候补辩手的被动光环能持续生效。
    - [ ]  **强制轮换:** 实现使用主动技能后，下一回合自动切换主辩手的逻辑。
    - [ ]  **角色羁绊 (Synergy):** 实现根据上场的角色阵容，在游戏开始时计算并激活羁绊效果的逻辑。

- **5. 回合流程控制器:**
    - [ ]  **回合驱动:** 实现一个从第1回合到第12回合的回合控制器。
    - [ ]  **阶段管理:** 在每回合内，实现“回合开始” -> “先手行动” -> “后手应对” -> “回合结束”的状态机。
    - [ ]  **先后手机制:** 实现奇数回合玩家A先手，偶数回合玩家B先手的轮换逻辑。
    - [ ]  **回合事件:** 在“回合开始”阶段，统一处理TP恢复、抽卡、技能CD减少等所有事件。

---

### 第三阶段：核心战斗逻辑与结算

**目标：** 实现游戏最核心的“辩论交锋”机制，并根据V5.0的收益表精确计算结果。

- **6. 辩论交锋流程:**
    - [ ]  实现先手方选择“论据卡”和“方式”（友好/辛辣）。
    - [ ]  实现后手方选择“应对卡”和“态度”（赞同/反驳）。
    - [ ]  实现“连续辩论”机制，包括疲劳递减（强度惩罚）和最多4次的限制。

- **7. 战斗结算引擎:**
    - [ ]  **核心收益表:** 将文档中的V5.0收益表完全代码化，创建一个函数，输入“强度差”、“攻方策略”、“守方策略”，输出“声望变化”、“议题偏向变化”和“额外效果”。
    - [ ]  **强度计算:** 在结算前，综合计算双方的最终强度（卡牌基础强度 + 羁绊/技能/议题偏向等各类Buff/Debuff）。
    - [ ]  **“完美反驳”:** 实现当防守方强度领先5点及以上时，中断对方连击的特殊逻辑。

- **8. 双轨胜利系统集成:**
    - [ ]  **声望系统:** 将结算引擎返回的声望变化应用到玩家身上，并随时检查是否有人声望归零。
    - [ ]  **议题偏向系统:**
        - [ ]  将结算引擎返回的议题偏向变化应用到全局状态。
        - [ ]  实现议题偏向的“临界点Buff”效果（±3, ±5, ±7, ±9）。
        - [ ]  随时检查议题偏向是否达到±10以触发即时胜利。
        - [ ]  实现议题的自然转换（每4回合）和强制转换机制。

---

### 第四阶段：UI/UX 与收尾

**目标：** 将所有后端逻辑与前端界面结合，提供完整的游戏体验。

- **9. UI界面开发:**
    - [ ]  根据文档中的战场布局，开发所有UI组件（玩家信息区、角色阵容区、手牌区、交锋区、议题偏向指示器）。
    - [ ]  实现卡牌和角色信息的动态展示。
    - [ ]  开发决策界面，如选择卡牌、选择策略的交互。

- **10. 前后端联动与视觉效果:**
    - [ ]  将所有游戏状态的变化（如声望增减、TP变化、抽卡动画）实时反映在UI上。
    - [ ]  为关键操作（如打出SSR卡、触发完美反驳、议题偏向大幅摆动）添加视觉特效。
    - [ ]  实现决策倒计时功能。

- **11. AI对手（可选）:**
    - [ ]  设计并实现一个基础的AI对手，能根据当前局势做出合理的决策（例如，声望落后时倾向于选择“赞同”保资源，议题领先时倾向于“辛辣点评”扩大优势）。
